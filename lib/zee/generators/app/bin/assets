#!/usr/bin/env ruby
# frozen_string_literal: true

# This script is used to generate the assets for the app.
# By default, it calls scripts from your package.json file.
# You can replace it with anything you want. The only requirement is that files
# must be exported to the `public/assets` folder.
#
# When deploying your app, you must call `zee assets` to generate the assets.

require "fileutils"
FileUtils.rm_rf("public/assets")
FileUtils.mkdir_p("public/assets")

# Compute aliases for esbuild, so you can import files by referencing the
# directory inside `app/assets/scripts` directly.
aliases = Dir["app/assets/scripts/*"].filter_map do |entry|
  next unless File.directory?(entry)

  dir = File.basename(entry)
  "--alias:#{dir}=./app/assets/scripts/#{dir}"
end

# Export script entrypoints
Dir["app/assets/scripts/*.{ts,js}"].each do |file|
  system "node_modules/.bin/esbuild",
         file,
         "--bundle",
         "--minify",
         "--sourcemap",
         "--outdir=public/assets",
         *aliases
end

puts

# Export style entrypoints
Dir["app/assets/styles/*.css"].each do |file|
  system "node_modules/.bin/tailwindcss",
         "--input", file,
         "--optimize",
         "--minify",
         "--output", File.join("public/assets", File.basename(file))
end
